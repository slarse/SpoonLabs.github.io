<!DOCTYPE html>
<html lang="en">
<html>
  <head>

 <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="getting-started,  ">
<title>Using Spoon for Architecture Enforcement  | Spoon</title>
<link rel="stylesheet" type="text/css" href="css/syntax.css">
<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/modern-business.css">
<link rel="stylesheet" type="text/css" href="css/lavish-bootstrap.css">
<link rel="canonical" href="/architecture_test.html">
<link rel="stylesheet" type="text/css" href="css/customstyles.css">
<link rel="stylesheet" type="text/css" href="css/theme-mauve.css">
<link rel="canonical" href="/architecture_test.html">
<link rel="alternate" type="application/rss+xml" title="" href="feed.xml" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->







 

  <script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
  </script>

  </head>

  <body>

   <!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Spoon</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                




                
                
                
                
                <li><a href="papers.html">Papers</a></li>
                
                
                
                
                
                <li><a href="ecosystem.html">Ecosystem</a></li>
                
                
                
                
                
                <li><a href="about.html">About</a></li>
                
                
                
                
                
                <li><a href="https://ci.inria.fr/sos/" target="_blank">Jenkins</a></li>
                
                
                
                
                
                <li><a href="https://github.com/INRIA/spoon" target="_blank">Github</a></li>
                
                
                
                


                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->

                <li class="dropdown">
                    
        </div>
        <!-- /.container -->
</nav>


    <!-- Page Content -->
    <div class="container">
      <div class="col-lg-12">&nbsp;</div>

      <!-- Content Row -->
<div class="row">
    <!-- Sidebar Column -->
    <div class="col-md-3">

        <script>

            $(document).ready(function() {
                        // Initialize navgoco with default options
                        $("#mysidebar").navgoco({
                            caretHtml: '',
                            accordion: true,
                            openClass: 'active', // open
                            save: false, // leave false or nav highlighting doesn't work right
                            cookie: {
                                name: 'navgoco',
                                expires: false,
                                path: '/'
                        },
                        slide: {
                            duration: 400,
                            easing: 'swing'
                                }
                                });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

            });

        </script>


        




        <ul id="mysidebar" class="nav">

            <div class="siteTagline">Spoon</div>

            
            
            
            <li><a href="#">Getting started</a>
                <ul>
                    
                    
                    
                    <li><a href="first_analysis_processor.html">Code Analysis</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li class="active"><a href="architecture_test.html">Architecture Checking</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="reflection.html">Runtime Reflection</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="custom-pretty-printing.html">Custom Java Pretty-Printing</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="processor.html">Processor for elements</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="http://spoon.gforge.inria.fr/mvnsites/spoon-core/apidocs" target="_blank">Javadoc</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="faq.html">FAQ</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Querying source code elements</a>
                <ul>
                    
                    
                    
                    <li><a href="filter.html">AST Traversing</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="path.html">AST Paths and Roles</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="matcher.html">Matcher</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="pattern.html">Pattern</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Code Transformation</a>
                <ul>
                    
                    
                    
                    <li><a href="first_transformation.html">Code Transformation</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="examples.html">Transformation Examples</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="processor_annotations.html">Transformation with annotations</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="template_definition.html">Transformation with Templates</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="pattern.html#generator">Code Generation</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="testing_quickstart.html">Testing transformations</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Usage</a>
                <ul>
                    
                    
                    
                    <li><a href="launcher.html">From Java</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="command_line.html">Command Line</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="maven.html">From Maven Plugin</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="gradle.html">From Gradle Plugin</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Spoon Meta model</a>
                <ul>
                    
                    
                    
                    <li><a href="structural_elements.html">Structural elements</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="code_elements.html">Code elements</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="references.html">References</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="factories.html">Create elements with factories</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="comments.html">Comments and Positions</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
        
        </ul>

        
    </div>
       <!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above.-->
    <script>$("li.active").parents('li').toggleClass("active");</script>


      <!-- Content Column -->
      <div class="col-md-9">

          <div class="post-header">
   <h1 class="post-title-main">Using Spoon for Architecture Enforcement</h1>
</div>

<div class="post-content">

   

  <p>In software, an architectural rule (aka architectural constraint) specifies a design decision on the application. Architectural rules cannot usually be expressed in the programming language itself.
Architectural rules can be written as AST analysis, which makes Spoon very appropriate to express and check them.
Since architectural rules must be automatically checked as often as possible, it&#39;s good to have them part of continuous integration.</p>

<p>To write an architectural rule in Spoon that is checked in CI, the idea is to write a standard Junit test case that loads the application code, express the rule and check it. Doing this only requires to depend on Spoon at testing time, ie <code>&lt;scope&gt;test&lt;/scope&gt;</code> in Maven.</p>

<h3 id="example-rule-never-use-the-treeset-constructor">Example rule: never use the TreeSet constructor</h3>

<p>For instance, let&#39;s imagine that you want to forbid the usage of <code>TreeSet</code>&#39;s constructor, in your code base, you would simply write a test case as follows:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">noTreeSet</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">SpoonAPI</span> <span class="n">spoon</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Launcher</span><span class="o">();</span>
    <span class="n">spoon</span><span class="o">.</span><span class="na">addInputResource</span><span class="o">(</span><span class="s">"src/main/java/"</span><span class="o">);</span>
    <span class="n">spoon</span><span class="o">.</span><span class="na">buildModel</span><span class="o">();</span>

    <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">spoon</span><span class="o">.</span><span class="na">getFactory</span><span class="o">().</span><span class="na">Package</span><span class="o">().</span><span class="na">getRootPackage</span><span class="o">().</span><span class="na">getElements</span><span class="o">(</span><span class="k">new</span> <span class="n">AbstractFilter</span><span class="o">&lt;</span><span class="n">CtConstructorCall</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">matches</span><span class="o">(</span><span class="n">CtConstructorCall</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getActualClass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">TreeSet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">};</span>
    <span class="o">}).</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div>
<p>That&#39;s it! Every time you run the tests, incl. on your continuous integration server, the architectural rules are enforced.</p>

<p>For instance, you can check that you never return null, or always use an appropriate factory, or that all classes implementing an interface are in the same package.</p>

<h3 id="example-rule-all-test-classes-must-start-or-end-with-quot-test-quot">Example rule: all test classes must start or end with &quot;Test&quot;</h3>

<p>A common mistake is to forget to follow a naming convention. For instance, if you use Maven, all test classes must be named <code>Test*</code> or <code>*Test</code> in order to be run by Maven&#39;s standard test plugin <code>surefire</code> (<a href="http://maven.apache.org/surefire/maven-surefire-plugin/examples/inclusion-exclusion.html">see doc</a>). This rule simply reads:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGoodTestClassNames</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">SpoonAPI</span> <span class="n">spoon</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Launcher</span><span class="o">();</span>
    <span class="n">spoon</span><span class="o">.</span><span class="na">addInputResource</span><span class="o">(</span><span class="s">"src/test/java/"</span><span class="o">);</span>
    <span class="n">spoon</span><span class="o">.</span><span class="na">buildModel</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">CtMethod</span><span class="o">&lt;?&gt;</span> <span class="n">meth</span> <span class="o">:</span> <span class="n">spoon</span><span class="o">.</span><span class="na">getModel</span><span class="o">().</span><span class="na">getRootPackage</span><span class="o">().</span><span class="na">getElements</span><span class="o">(</span><span class="k">new</span> <span class="n">TypeFilter</span><span class="o">&lt;</span><span class="n">CtMethod</span><span class="o">&gt;(</span><span class="n">CtMethod</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">matches</span><span class="o">(</span><span class="n">CtMethod</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">element</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">element</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Test</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
    <span class="o">}))</span> <span class="o">{</span>
            <span class="n">assertTrue</span><span class="o">(</span><span class="s">"naming contract violated for "</span><span class="o">+</span><span class="n">meth</span><span class="o">.</span><span class="na">getParent</span><span class="o">(</span><span class="n">CtClass</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">meth</span><span class="o">.</span><span class="na">getParent</span><span class="o">(</span><span class="n">CtClass</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getSimpleName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"Test"</span><span class="o">)</span> <span class="o">||</span> <span class="n">meth</span><span class="o">.</span><span class="na">getParent</span><span class="o">(</span><span class="n">CtClass</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getSimpleName</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"Test"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<h3 id="example-rule-all-public-methods-must-be-documented">Example rule: all public methods must be documented</h3>

<p>How to check that all public methods of the API contain proper Javadoc? One can also use Spoon to check documentation rules like this one.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDocumentation</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">SpoonAPI</span> <span class="n">spoon</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Launcher</span><span class="o">();</span>
    <span class="n">spoon</span><span class="o">.</span><span class="na">addInputResource</span><span class="o">(</span><span class="s">"src/main/java/"</span><span class="o">);</span>
    <span class="n">spoon</span><span class="o">.</span><span class="na">buildModel</span><span class="o">();</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">notDocumented</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">CtMethod</span> <span class="n">method</span> <span class="o">:</span> <span class="n">spoon</span><span class="o">.</span><span class="na">getModel</span><span class="o">().</span><span class="na">getElements</span><span class="o">(</span><span class="k">new</span> <span class="n">TypeFilter</span><span class="o">&lt;&gt;(</span><span class="n">CtMethod</span><span class="o">.</span><span class="na">class</span><span class="o">)))</span> <span class="o">{</span>
            <span class="c1">// now we see whether this should be documented</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">hasModifier</span><span class="o">(</span><span class="n">ModifierKind</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">)</span>
                <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">getTopDefinitions</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1">// optional: only the top declarations should be documented (not the overriding methods which are lower in the hierarchy)</span>
            <span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// is it really well documented?</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDocComment</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// at least 20 characters</span>
                            <span class="n">notDocumented</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getParent</span><span class="o">(</span><span class="n">CtType</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getQualifiedName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"#"</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getSignature</span><span class="o">());</span>
                    <span class="o">}</span>
            <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">notDocumented</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fail</span><span class="o">(</span><span class="n">notDocumented</span><span class="o">.</span><span class="na">size</span><span class="o">()+</span><span class="s">" public methods should be documented with proper API documentation: \n"</span><span class="o">+</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">notDocumented</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<h3 id="example-rule-all-private-fields-mustn-39-t-be-unused">Example rule: all private fields mustn&#39;t be unused.</h3>

<p>How to check that all private fields are used?
We define used here as every field has a read. We can skip the check for writes, because a read to a field will never happen without a write.
In 8 simple steps we can check this. You can easily extend this for public fields, but sometime public fields together expose an API and have no read.
Or you extend the check for writes. This could find fields reading a field before a write. 
<code>java
    // Step 1: create model
    SpoonAPI spoon = new Launcher();
    spoon.addInputResource(&quot;src/main/java/&quot;);
    CtModel model = spoon.buildModel();
    // Step2: Query the model for all fields
    List&lt;CtField&lt;?&gt;&gt; fields = model.getElements(new TypeFilter&lt;&gt;(CtField.class));
    // Step 3: Remove fields not matching conditions. Our conditions here are:
    // 1. Only private fields
    // 2. No serialization fields  
    // Filter non private fields
    fields.removeIf(v -&gt; !v.isPrivate());
    // remove fields for serialization gods
    fields.removeIf(v -&gt; v.getSimpleName().equals(&quot;serialVersionUID&quot;));
    // Step 4: Query the model for all fieldReads
    List&lt;CtFieldRead&lt;?&gt;&gt; fieldRead = model.getElements(new TypeFilter&lt;&gt;(CtFieldRead.class));
    // some fieldReads have no variable declaration
    fieldRead.removeIf(v -&gt; v.getVariable().getFieldDeclaration() == null);
    // convert to HashSet for faster lookup. We trade memory for lookup speed.
    // Step 5: Query every fieldRead for there declaring field 
    HashSet&lt;CtField&lt;?&gt;&gt; lookUp = fieldRead.stream()
            .map(CtFieldRead::getVariable)
            .map(v -&gt; v.getFieldDeclaration())
                    .collect(Collectors.toCollection(HashSet::new));
    // Step 6: Lookup every field in the set. The set contains all fields, that have a read.
    List&lt;CtField&lt;?&gt;&gt; fieldsWithRead = fields.stream()
            //   every field must have a read
            .filter(field -&gt; lookUp.contains(field))
    .collect(Collectors.toList());
    // Step 7: Remove the fields having a read from the set of fields. 
    fields.removeAll(fieldsWithRead);
    // Step 8: Lets compare our result. if the set is empty, every field has a read, otherwise print the fields without read. 
    assertEquals(&quot;Some Fields have no read/write&quot;, Collections.emptyList(), fields);
</code></p>

<h3 id="related-work-in-architecture-enforcement">Related work in architecture enforcement</h3>

<ul>
<li><a href="https://saturnnetwork.wordpress.com/2012/11/26/ultimate-architecture-enforcement-prevent-code-violations-at-code-commit-time/">Architecture enforcement with Checkstyle</a></li>
<li><a href="https://docs.sonarqube.org/display/SONARQUBE44/Architecture+Rule+Engine">Sonar architecture rule engine</a></li>
<li><a href="https://www.archunit.org/">Archunit:  specify and assert architecture rules in plain Java</a> (<a href="https://github.com/societe-generale/arch-unit-maven-plugin">Maven integration</a>)</li>
<li><a href="https://jqassistant.org/">jqassistant</a> does architectural checking on top of Neo4J.</li>
</ul>






















































































































































</div>

<hr class="shaded"/> 

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               	<a href="https://github.com/INRIA/spoon/issues/new">Contact / Feedback / Question / Bug Report</a><br />
                Site last generated: Jan 18, 2021 <br />
                </div>
            </div>
        </footer>

      </div><!-- /.row -->

    </div>    <!-- /.container -->

  </body>

  
  <!-- the google_analytics_id gets auto inserted from the config file -->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-24273081-1', 'auto');
    ga('send', 'pageview');
</script>

  

</html>

